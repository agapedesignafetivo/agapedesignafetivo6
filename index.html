<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Feito por Criis</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      height: 100%;
      width: 100%;
    }

    #camera-wrap {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: black;
    }

    video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: black;
    }

    #frame, #frame2 {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    #buttons {
      position: fixed;
      bottom: 25px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 20;
    }

    button {
      padding: 8px 16px;
      border: 2px solid red;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      background: white;
      color: black;
      cursor: pointer;
      text-align: center;
    }

    button:hover {
      opacity: 0.9;
    }

    #download { display: none; }

    /* Defini√ß√£o do estilo das part√≠culas de brilho */
    .brilho {
      position: absolute;
      pointer-events: none;
      background-size: contain; /* Ajusta a imagem dentro da part√≠cula */
      background-repeat: no-repeat;
      transition: all 0.3s ease-out;
    }
  </style>
</head>
<body>

  <div id="camera-wrap">
    <video id="video" autoplay playsinline muted></video>
    <img id="frame" src="moldura.png">
    <img id="frame2" src="moldura2.png" style="display:none;">
  </div>

  <div id="buttons">
    <button id="switchBtn">Trocar c√¢mera üîÑ</button>
    <button id="snapBtn">Tirar Foto üì∏</button>
    <button id="switchFrameBtn">Trocar Moldura üñºÔ∏è</button>
  </div>

  <a id="download" download="fotomoldurapersonalizada.png"></a>

  <script>
    const video = document.getElementById("video");
    const frame = document.getElementById("frame");
    const frame2 = document.getElementById("frame2");
    const snapBtn = document.getElementById("snapBtn");
    const switchBtn = document.getElementById("switchBtn");
    const switchFrameBtn = document.getElementById("switchFrameBtn");
    const download = document.getElementById("download");
    const brilhoContainer = document.getElementById("camera-wrap");

    let stream = null;
    let usingFront = true;
    let usingFrame2 = false;

    let brilhos = [];
    
    // Fun√ß√£o para criar a part√≠cula de brilho com a imagem
    function criarBrilho() {
      const brilho = document.createElement("div");
      brilho.classList.add("brilho");

      // Adiciona a imagem de brilho
      brilho.style.backgroundImage = "url('brilho.png')"; // Coloque o caminho da sua imagem de brilho

      // Definir o tamanho da part√≠cula
      const size = Math.random() * 20 + 10;  // Tamanho aleat√≥rio entre 10 e 30px
      brilho.style.width = `${size}px`;
      brilho.style.height = `${size}px`;

      // Inicializar a posi√ß√£o da part√≠cula
      brilho.style.left = `${Math.random() * 100}%`;
      brilho.style.top = `${Math.random() * 100}%`;
      brilho.style.opacity = Math.random() * 0.5 + 0.5; // Opacidade aleat√≥ria

      brilhoContainer.appendChild(brilho);

      // Adiciona a part√≠cula ao array para controle
      brilhos.push({
        element: brilho,
        top: parseFloat(brilho.style.top),
        left: parseFloat(brilho.style.left),
        dx: (Math.random() - 0.5) * 2, // Velocidade horizontal
        dy: (Math.random() - 0.5) * 2, // Velocidade vertical
        size: size
      });
    }

    // Fun√ß√£o para remover brilhos antigos (quando atingem o limite)
    function removerBrilhos() {
      if (brilhos.length > 100) { // Se o n√∫mero de brilhos for maior que 100, remove os antigos
        const brilhoRemovido = brilhos.shift();
        brilhoRemovido.element.remove();
      }
    }

    // Fun√ß√£o para animar as part√≠culas de brilho
    function animarBrilhos() {
      brilhos.forEach((brilho, index) => {
        brilho.top += brilho.dy;
        brilho.left += brilho.dx;

        // Coloca a part√≠cula de volta na tela se ela sair dos limites
        if (brilho.top > 100) brilho.top = 0;
        if (brilho.left > 100) brilho.left = 0;
        if (brilho.top < 0) brilho.top = 100;
        if (brilho.left < 0) brilho.left = 100;

        brilho.element.style.top = `${brilho.top}%`;
        brilho.element.style.left = `${brilho.left}%`;

        // Cria part√≠culas novas a cada intervalo
        if (Math.random() < 0.03) criarBrilho();
      });

      requestAnimationFrame(animarBrilhos);
    }

    // Fun√ß√£o para come√ßar a c√¢mera
    async function startCamera(){
      if(stream){
        stream.getTracks().forEach(t => t.stop());
      }

      const constraints = {
        video: { facingMode: usingFront ? "user" : "environment" }
      };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      // Espelhamento apenas NO PREVIEW
      video.style.transform = usingFront ? "scaleX(-1)" : "scaleX(1)";

      await waitForVideoReady();
    }

    function waitForVideoReady(){
      return new Promise(resolve => {
        if(video.readyState >= 2 && video.videoWidth > 0){
          resolve();
          return;
        }
        video.onloadedmetadata = () => resolve();
      });
    }

    // Trocar c√¢mera
    switchBtn.addEventListener("click", () => {
      usingFront = !usingFront;
      startCamera();
    });

    // Alternar entre as molduras
    switchFrameBtn.addEventListener("click", () => {
      usingFrame2 = !usingFrame2;
      if (usingFrame2) {
        frame.style.display = "none";
        frame2.style.display = "block";
      } else {
        frame.style.display = "block";
        frame2.style.display = "none";
      }
    });

    // Inicializa a anima√ß√£o das part√≠culas
    setInterval(() => {
      criarBrilho();
      removerBrilhos();
    }, 200);  // Adiciona uma part√≠cula a cada 200ms

    animarBrilhos(); // Come√ßa a anima√ß√£o das part√≠culas

    snapBtn.addEventListener("click", async () => {
      await waitForVideoReady();

      const vw = video.videoWidth;
      const vh = video.videoHeight;

      const targetW = 720;
      const targetH = 1280;

      const canvas = document.createElement("canvas");
      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext("2d");

      const buffer = document.createElement("canvas");
      buffer.width = targetW;
      buffer.height = targetH;
      const btx = buffer.getContext("2d");

      btx.save();
      if (usingFront) {
        btx.translate(targetW, 0);
        btx.scale(-1, 1);
      }

      const videoRatio = vw / vh;
      const targetRatio = targetW / targetH;

      let sx, sy, sw, sh;

      if (videoRatio > targetRatio) {
        sh = vh;
        sw = sh * targetRatio;
        sx = (vw - sw) / 2;
        sy = 0;
      } else {
        sw = vw;
        sh = sw / targetRatio;
        sx = 0;
        sy = (vh - sh) / 2;
      }

      btx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
      btx.restore();

      ctx.drawImage(buffer, 0, 0);

      if (usingFrame2) {
        ctx.drawImage(frame2, 0, 0, targetW, targetH);
      } else {
        ctx.drawImage(frame, 0, 0, targetW, targetH);
      }

      const img = canvas.toDataURL("image/png");
      download.href = img;
      download.click();
    });

    startCamera();
  </script>

</body>
</html>
